# Deployment Guide

## GitHub Actions Auto-Deploy

Автоматический деплой настроен через GitHub Actions. При каждом push в ветку `main` происходит автоматическое развертывание на сервере.

## Настройка GitHub Secrets

Для работы автодеплоя необходимо настроить следующие секреты в GitHub:

1. Перейдите в Settings → Secrets and variables → Actions
2. Добавьте следующие секреты:

### Обязательные секреты:

- **`VM_SSH_KEY`** - Приватный SSH ключ для доступа к серверу
  ```bash
  # Содержимое файла ~/.ssh/ocivm_key
  ```

- **`VM_USER`** - Пользователь для SSH подключения
  ```
  opc
  ```

- **`VM_HOST`** - IP адрес или hostname сервера
  ```
  130.162.224.203
  ```

## Процесс деплоя

GitHub Actions workflow выполняет следующие шаги:

1. **Остановка приложения** - Останавливает текущее приложение и освобождает память
2. **Копирование файлов** - Синхронизирует код на сервер (исключая `target`, `.git`, `.class`)
3. **Сборка проекта** - Собирает проект на сервере с ограничением памяти (`-Xmx256m` для Maven)
4. **Запуск приложения** - Запускает приложение с ограничением памяти (`-Xmx512m` для Java)
5. **Проверка** - Проверяет, что приложение успешно запустилось

## Ручное управление приложением

На сервере доступен скрипт `/home/opc/deploy.sh` для ручного управления:

```bash
# Проверить статус
ssh opc@130.162.224.203 "/home/opc/deploy.sh status"

# Остановить приложение
ssh opc@130.162.224.203 "/home/opc/deploy.sh stop"

# Собрать проект
ssh opc@130.162.224.203 "/home/opc/deploy.sh build"

# Запустить приложение
ssh opc@130.162.224.203 "/home/opc/deploy.sh start"

# Полный деплой (остановить → собрать → запустить)
ssh opc@130.162.224.203 "/home/opc/deploy.sh deploy"

# Просмотр логов
ssh opc@130.162.224.203 "/home/opc/deploy.sh logs"
```

## Ограничения памяти

Сервер имеет только 1 ГБ памяти, поэтому:

- Maven использует максимум 256 MB (`MAVEN_OPTS="-Xmx256m -Xms128m"`)
- Java приложение использует максимум 512 MB (`-Xmx512m -Xms256m`)
- Перед сборкой приложение всегда останавливается
- Очищается кэш памяти перед операциями

## Структура на сервере

```
/home/opc/
├── bewerbung-ai/          # Директория проекта
│   ├── target/            # Собранные артефакты
│   │   └── bewerbung-ai-1.0.0.jar
│   ├── app.pid            # PID файл запущенного приложения
│   └── app.log             # Логи приложения
├── jdk-21.0.2/            # JDK 21
├── apache-maven-3.9.5/    # Maven 3.9.5
└── deploy.sh              # Скрипт управления приложением
```

## Переменные окружения

Приложение использует файл `variables.env` в корне проекта для конфигурации. Убедитесь, что файл существует на сервере с необходимыми переменными:

- `GPT_API_KEY` - OpenAI API ключ
- `EMAIL_API_KEY` - API ключ для отправки email
- `EMAIL_API_PROVIDER` - Провайдер email (brevo, sendgrid, mailgun)
- `PORT` - Порт приложения (по умолчанию 8080)
- И другие переменные из `application.properties`

## Просмотр процесса деплоя в реальном времени

### Во время GitHub Actions деплоя

Все логи сборки и деплоя отображаются в GitHub Actions. Перейдите в:
- **Actions** → выберите нужный workflow run → **deploy** job

Вы увидите:
- Вывод каждого шага
- Логи сборки Maven
- Статус памяти
- Результат деплоя

### Подключение к серверу во время деплоя

Если нужно смотреть процесс на сервере в реальном времени:

```bash
# 1. Подключитесь к серверу
ssh -i ~/.ssh/ocivm_key opc@130.162.224.203

# 2. Смотрите логи сборки в реальном времени
tail -f /home/opc/bewerbung-ai/build.log

# 3. Или смотрите логи приложения
tail -f /home/opc/bewerbung-ai/app.log

# 4. Или смотрите процессы
watch -n 1 'ps aux | grep -E "maven|java" | grep -v grep'

# 5. Или используйте tmux для сессии
tmux new -s deploy
# Внутри tmux:
cd /home/opc/bewerbung-ai
tail -f build.log app.log
# Отключиться: Ctrl+B, затем D
# Подключиться обратно: tmux attach -t deploy
```

### Использование tmux для мониторинга

```bash
# На сервере создать сессию мониторинга
ssh opc@130.162.224.203
tmux new -s monitor

# Внутри tmux можно разделить экран (Ctrl+B, затем %)
# Слева: tail -f /home/opc/bewerbung-ai/build.log
# Справа: tail -f /home/opc/bewerbung-ai/app.log

# Отключиться: Ctrl+B, затем D
# Подключиться обратно: tmux attach -t monitor
```

### Ручной деплой с выводом в реальном времени

```bash
# Подключитесь к серверу и запустите деплой вручную
ssh opc@130.162.224.203

# Вариант 1: Использовать скрипт (вывод будет виден)
/home/opc/deploy.sh deploy

# Вариант 2: Запустить сборку с выводом
cd /home/opc/bewerbung-ai
export PATH=/home/opc/jdk-21.0.2/bin:/home/opc/apache-maven-3.9.5/bin:$PATH
export MAVEN_OPTS="-Xmx256m -Xms128m"
mvn clean package -DskipTests
```

### Просмотр логов после деплоя

```bash
# Логи сборки
ssh opc@130.162.224.203 "tail -100 /home/opc/bewerbung-ai/build.log"

# Логи приложения
ssh opc@130.162.224.203 "tail -100 /home/opc/bewerbung-ai/app.log"

# Статус приложения
ssh opc@130.162.224.203 "/home/opc/deploy.sh status"
```

### Использование скрипта мониторинга (рекомендуется)

Для удобного мониторинга используйте локальный скрипт:

```bash
# Запустите скрипт мониторинга
./monitor-deploy.sh
```

Скрипт предоставляет интерактивное меню:
- Просмотр логов сборки в реальном времени
- Просмотр логов приложения в реальном времени
- Разделенный экран (tmux) для одновременного просмотра обоих логов
- Мониторинг процессов (maven/java)
- Статус деплоя
- Просмотр последних строк логов
- Интерактивная SSH сессия

## Troubleshooting

### Приложение не запускается

1. Проверьте логи:
   ```bash
   ssh opc@130.162.224.203 "tail -50 /home/opc/bewerbung-ai/app.log"
   ```

2. Проверьте статус:
   ```bash
   ssh opc@130.162.224.203 "/home/opc/deploy.sh status"
   ```

3. Проверьте память:
   ```bash
   ssh opc@130.162.224.203 "free -h"
   ```

### Ошибка сборки

1. Убедитесь, что JDK и Maven установлены:
   ```bash
   ssh opc@130.162.224.203 "java -version && mvn -version"
   ```

2. Проверьте, что приложение остановлено перед сборкой

### GitHub Actions не работает

1. Проверьте, что все секреты настроены правильно
2. Проверьте SSH ключ - он должен быть приватным ключом без пароля
3. Проверьте логи GitHub Actions в разделе Actions

