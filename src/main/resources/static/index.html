<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bewerbung AI - Document Generator</title>
    <!-- Tailwind CSS via CDN for the full UI styling -->
    <script>
        // Tailwind config: enable class-based dark mode for theme toggle
        window.tailwind = window.tailwind || {};
        window.tailwind.config = Object.assign(window.tailwind.config || {}, { darkMode: 'class' });
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Single font family (Inter with system fallback) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Minimal custom styles for the SVG progress ring (not covered by Tailwind) */
        .progress-ring {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-segment {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke 0.4s ease;
        }

        .progress-segment.active {
            stroke: url(#gradient);
        }

        .progress-segment.active.blinking {
            animation: blink-segment 1.2s ease-in-out infinite;
        }

        @keyframes blink-segment {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.4;
            }
        }

        .progress-segment.inactive {
            stroke: #e5e7eb;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 600;
            color: #0f172a;
            text-align: center;
        }

        .progress-label {
            margin-top: 24px;
            font-size: 14px;
            color: #64748b;
            text-align: center;
            min-height: 24px;
            font-weight: 500;
        }

        .progress-label.active {
            color: #1d4ed8;
        }

        /* Dark theme adjustments for the SVG progress UI */
        .dark .progress-segment.inactive {
            stroke: #334155;
        }

        .dark .progress-text {
            color: #e2e8f0;
        }

        .dark .progress-label {
            color: #94a3b8;
        }

        .dark .progress-label.active {
            color: #60a5fa;
        }

        /* Dark theme fallback overrides (in case dark: classes are not generated by CDN) */
        html.dark body,
        body.dark {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        html.dark .container,
        body.dark .container {
            background-color: #020617;
            box-shadow: 0 0 0 1px #1e293b;
        }

        html.dark label,
        body.dark label {
            color: #e2e8f0;
        }

        html.dark textarea,
        body.dark textarea {
            background-color: #0f172a;
            color: #e2e8f0;
            border-color: #334155;
        }

        html.dark #themeToggle,
        body.dark #themeToggle {
            background-color: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        html.dark #generateButton,
        body.dark #generateButton {
            background-color: #2563eb;
        }

        html.dark #generateButton:hover,
        body.dark #generateButton:hover {
            background-color: #1d4ed8;
        }

        html.dark #downloadButton,
        body.dark #downloadButton {
            background-color: #0f172a;
            border-color: #3b82f6;
            color: #bfdbfe;
        }

        html.dark #downloadButton:hover,
        body.dark #downloadButton:hover {
            background-color: #1e293b;
        }

        html.dark #loading,
        body.dark #loading {
            background-color: #020617;
            border-color: #1e293b;
            color: #cbd5f5;
        }

        html.dark .result-section,
        body.dark .result-section {
            background-color: rgba(15, 23, 42, 0.7);
            border-color: #334155;
        }

        html.dark .error,
        body.dark .error {
            background-color: rgba(127, 29, 29, 0.25);
            border-color: #7f1d1d;
            color: #fecaca;
        }

        html.dark .error .result-content,
        body.dark .error .result-content {
            background-color: #0f172a;
            border-color: #7f1d1d;
            color: #fecaca;
        }

        html.dark footer,
        body.dark footer {
            border-color: #1e293b;
            color: #94a3b8;
        }

        html.dark footer h3,
        body.dark footer h3 {
            color: #e2e8f0;
        }

        html.dark .app-title,
        body.dark .app-title {
            color: #f8fafc;
        }

        /* Language selector styling */
        #languageSelector {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            padding-right: 2rem;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 antialiased dark:bg-slate-900 dark:text-slate-100 dark" style="font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;">
    <!-- Page container (single column layout: form -> result) -->
    <div class="container mx-auto max-w-5xl rounded-2xl bg-white px-6 py-8 shadow-sm ring-1 ring-slate-200 dark:bg-slate-950 dark:ring-slate-800 sm:px-10 sm:py-10">
        <!-- Header: title and theme toggle -->
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <h1 class="app-title text-center text-2xl font-semibold tracking-tight text-slate-900 dark:text-white sm:text-left sm:text-3xl" data-i18n="appTitle">Bewerbunganschreiben AI</h1>
            <div class="flex items-center gap-2">
                <!-- Language selector -->
                <div class="relative inline-block">
                    <select id="languageSelector" class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 shadow-sm transition-colors hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 appearance-none pr-8 cursor-pointer">
                        <option value="de">DE</option>
                        <option value="ru">RU</option>
                        <option value="en">EN</option>
                    </select>
                </div>
                <!-- Theme toggle (pure frontend; no backend interaction) -->
                <button type="button" id="themeToggle" class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 shadow-sm transition-colors hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800" data-i18n="themeToggle">Dunkelmodus</button>
            </div>
        </div>

        <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50/60 px-6 py-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <p class="text-sm text-slate-600 dark:text-slate-300" data-i18n="reviewPrompt">Ich wäre Ihnen dankbar, wenn Sie mir ein paar Zeilen mit Ihren Eindrücken zu diesem Service hinterlassen</p>
                <a href="/reviews.html" class="inline-flex items-center justify-center rounded-xl border border-blue-600 bg-white px-5 py-2 text-sm font-semibold text-blue-700 shadow-sm transition-colors hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 dark:border-blue-500 dark:bg-slate-900 dark:text-blue-200 dark:hover:bg-slate-800" data-i18n="submitReview">Bewertung abgeben</a>
            </div>
        </div>
        
        <!-- Input form (IDs must stay stable for JS bindings) -->
        <form id="generateForm" class="mt-8 space-y-6">
            <div class="form-group space-y-2">
                <label for="biographyTextarea" class="block text-sm font-medium text-slate-700 dark:text-slate-200" data-i18n="biographyLabel">Biography - Verfassen Sie Ihren Lebenslauf in einem freien Format: Persönliches
                    Daten, Ihre Fähigkeiten, Berufserfahrung, Ausbildung:</label>
                <textarea id="biographyTextarea" name="biography" required class="min-h-[300px] w-full resize-y rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-800 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-900"></textarea>
            </div>
            
            <div class="form-group space-y-2">
                <label for="jobPostingTextarea" class="block text-sm font-medium text-slate-700 dark:text-slate-200" data-i18n="jobPostingLabel">Job Posting - kopieren Sie einfach den Text der Stellenanzeige hierher.:</label>
                <textarea id="jobPostingTextarea" name="jobPosting" required class="min-h-[200px] w-full resize-y rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-800 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-900"></textarea>
            </div>
            
            <div class="form-group space-y-2">
                <label for="wishesTextarea" class="block text-sm font-medium text-slate-700 dark:text-slate-200" data-i18n="wishesLabel">Wünsche und Korrekturen - schreiben Sie Ihre Wünsche oder Korrekturen, wenn Sie mit dem Ergebnis nicht einverstanden sind (optional):</label>
                <textarea id="wishesTextarea" name="wishes" class="min-h-[150px] w-full resize-y rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-800 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-900"></textarea>
            </div>
            
            <button type="submit" id="generateButton" class="w-full rounded-xl bg-blue-600 px-6 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:bg-slate-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:disabled:bg-slate-700" data-i18n="generateButton">Dokumente erstellen</button>
        </form>

        <!-- Loading state (visibility controlled by JS via .hidden class) -->
        <div id="loading" class="loading hidden mt-8 rounded-2xl border border-slate-200 bg-white px-6 py-10 text-center text-sm text-slate-600 shadow-sm dark:border-slate-700 dark:bg-slate-950 dark:text-slate-300">
            <div class="progress-container flex flex-col items-center justify-center">
                <div class="progress-ring">
                    <svg viewBox="0 0 100 100">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#5dade2;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- Segments will be generated by JavaScript -->
                    </svg>
                    <div class="progress-text" id="progressPercent">0%</div>
                </div>
                <div class="progress-label" id="progressLabel" data-i18n="progressInitializing">Initialisiere...</div>
            </div>
        </div>

        <!-- Error output (filled by JS) -->
        <div id="errorSection" class="results hidden mt-8">
            <div class="result-section error rounded-2xl border border-red-200 bg-red-50 px-6 py-5 text-red-700 shadow-sm dark:border-red-900/60 dark:bg-red-950/40 dark:text-red-200">
                <h2 class="text-base font-semibold text-red-700 dark:text-red-200" data-i18n="errorTitle">Error</h2>
                <div class="result-content mt-3 whitespace-pre-wrap rounded-xl border border-red-200 bg-white px-4 py-3 text-sm text-red-700 dark:border-red-900/60 dark:bg-slate-900 dark:text-red-200" id="errorContent"></div>
            </div>
        </div>

        <!-- Results output (filled by JS) -->
        <div id="results" class="results hidden mt-8">
            <div class="result-section rounded-2xl border border-slate-200 bg-slate-50/60 px-6 py-5 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
                <h2 class="text-base font-semibold text-slate-900 dark:text-slate-100" data-i18n="coverLetterTitle">Cover Letter (Anschreiben)</h2>
                <textarea id="coverLetterTextarea" class="result-content editable mt-3 min-h-[400px] w-full resize-y rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-800 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-900"></textarea>
                <button type="button" id="downloadButton" class="mt-4 w-full rounded-xl border border-blue-600 bg-white px-6 py-3 text-sm font-semibold text-blue-700 shadow-sm transition-colors hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60 dark:border-blue-500 dark:bg-slate-900 dark:text-blue-200 dark:hover:bg-slate-800" data-i18n="downloadButton">Herunterladen (PDF)</button>
            </div>
        </div>

        <!-- Legal footer / privacy note -->
        <footer class="mt-10 border-t border-slate-200 pt-6 text-center text-xs text-slate-500 dark:border-slate-800 dark:text-slate-400">
            <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-200" data-i18n="privacyTitle">Datenschutz</h3>
            <p class="mt-2 leading-relaxed" data-i18n="privacyText">Wir speichern keine personenbezogenen Daten dauerhaft. Eingegebene Inhalte werden ausschließlich zur unmittelbaren Verarbeitung verwendet und nach Beendigung der Sitzung automatisch gelöscht. Die technische Bereitstellung erfolgt über Railway, die Verarbeitung bestimmter Inhalte über die OpenAI-API – jeweils gemäß den Anforderungen der DSGVO.</p>
        </footer>
    </div>

    <script>
        // Theme toggle (frontend only, no backend dependency)
        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const rootElement = document.documentElement;
            const THEME_STORAGE_KEY = 'bewerbung-ai-theme';
            const THEME_VERSION_KEY = 'bewerbung-ai-theme-version';
            const THEME_VERSION = '2';

            function safeGetStoredValue(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    return null;
                }
            }

            function safeStoreValue(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (error) {
                    // Storage can be blocked on some mobile browsers; ignore silently.
                }
            }

            function applyTheme(theme) {
                const isDark = theme === 'dark';
                rootElement.classList.toggle('dark', isDark);
                if (document.body) {
                    document.body.classList.toggle('dark', isDark);
                }
                if (themeToggle && window.i18n) {
                    themeToggle.textContent = isDark 
                        ? window.i18n.translate('themeToggleLight') 
                        : window.i18n.translate('themeToggle');
                } else if (themeToggle) {
                    themeToggle.textContent = isDark ? 'Hellmodus' : 'Dunkelmodus';
                }
            }

            const storedTheme = safeGetStoredValue(THEME_STORAGE_KEY);
            const storedVersion = safeGetStoredValue(THEME_VERSION_KEY);
            if (storedVersion !== THEME_VERSION) {
                // Force default dark when theme settings schema changes
                applyTheme('dark');
                safeStoreValue(THEME_STORAGE_KEY, 'dark');
                safeStoreValue(THEME_VERSION_KEY, THEME_VERSION);
            } else if (storedTheme === 'dark' || storedTheme === 'light') {
                applyTheme(storedTheme);
            } else {
                // Default theme is dark as requested
                applyTheme('dark');
            }

            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const nextTheme = rootElement.classList.contains('dark') ? 'light' : 'dark';
                    applyTheme(nextTheme);
                    safeStoreValue(THEME_STORAGE_KEY, nextTheme);
                    safeStoreValue(THEME_VERSION_KEY, THEME_VERSION);
                });
            }
        })();

        // Language/i18n Management
        (function initLanguageSystem() {
            const LANGUAGE_STORAGE_KEY = 'bewerbung-ai-language';
            const translations = {
                de: {
                    appTitle: 'Bewerbunganschreiben AI',
                    themeToggle: 'Dunkelmodus',
                    themeToggleLight: 'Hellmodus',
                    reviewPrompt: 'Ich wäre Ihnen dankbar, wenn Sie mir ein paar Zeilen mit Ihren Eindrücken zu diesem Service hinterlassen',
                    submitReview: 'Bewertung abgeben',
                    biographyLabel: 'Biography - Verfassen Sie Ihren Lebenslauf in einem freien Format: Ihre Fähigkeiten, Berufserfahrung, Ausbildung:',
                    jobPostingLabel: 'Job Posting - kopieren Sie einfach den Text der Stellenanzeige hierher.:',
                    wishesLabel: 'Wünsche und Korrekturen - schreiben Sie Ihre Wünsche oder Korrekturen, wenn Sie mit dem Ergebnis nicht einverstanden sind (optional):',
                    generateButton: 'Dokumente erstellen',
                    progressInitializing: 'Initialisiere...',
                    progressReadingBiography: 'Lese Lebenslauf',
                    progressAnalyzingBiography: 'Analysiere Lebenslauf',
                    progressReadingJobPosting: 'Lese Stellenausschreibung',
                    progressAnalyzingJobPosting: 'Analysiere Stellenausschreibung',
                    progressCreatingLetter: 'Erstelle Anschreiben',
                    progressGenerating: 'Generiere Inhalt...',
                    progressFinalizing: 'Finalisiere Dokument',
                    progressComplete: 'Abgeschlossen',
                    errorTitle: 'Error',
                    coverLetterTitle: 'Cover Letter (Anschreiben)',
                    downloadButton: 'Herunterladen (PDF)',
                    downloadButtonGenerating: 'PDF wird generiert...',
                    privacyTitle: 'Datenschutz',
                    privacyText: 'Wir speichern keine personenbezogenen Daten dauerhaft. Eingegebene Inhalte werden ausschließlich zur unmittelbaren Verarbeitung verwendet und nach Beendigung der Sitzung automatisch gelöscht. Die technische Bereitstellung erfolgt über Railway, die Verarbeitung bestimmter Inhalte über die OpenAI-API – jeweils gemäß den Anforderungen der DSGVO.',
                    errorBiographyEmpty: 'Biography cannot be empty',
                    errorJobPostingEmpty: 'Job posting cannot be empty',
                    errorInvalidResponse: 'Invalid response from server',
                    errorApiError: 'An error occurred',
                    errorPdfGeneration: 'PDF-Generierung fehlgeschlagen',
                    errorPdfError: 'Fehler beim Generieren des PDFs: ',
                    alertFillLetter: 'Bitte füllen Sie zuerst das Anschreiben aus.'
                },
                ru: {
                    appTitle: 'Bewerbunganschreiben AI',
                    themeToggle: 'Темный режим',
                    themeToggleLight: 'Светлый режим',
                    reviewPrompt: 'Буду благодарен, если вы оставите несколько строк с вашими впечатлениями об этом сервисе',
                    submitReview: 'Оставить отзыв',
                    biographyLabel: 'Биография - Составьте свое резюме в свободном формате: ваши навыки, профессиональный опыт, образование:',
                    jobPostingLabel: 'Вакансия - просто скопируйте текст объявления о вакансии сюда.:',
                    wishesLabel: 'Пожелания и исправления - напишите ваши пожелания или исправления, если вы не согласны с результатом (необязательно):',
                    generateButton: 'Создать документы',
                    progressInitializing: 'Инициализация...',
                    progressReadingBiography: 'Чтение резюме',
                    progressAnalyzingBiography: 'Анализ резюме',
                    progressReadingJobPosting: 'Чтение вакансии',
                    progressAnalyzingJobPosting: 'Анализ вакансии',
                    progressCreatingLetter: 'Создание письма',
                    progressGenerating: 'Генерация содержимого...',
                    progressFinalizing: 'Завершение документа',
                    progressComplete: 'Завершено',
                    errorTitle: 'Ошибка',
                    coverLetterTitle: 'Cover Letter (Anschreiben)',
                    downloadButton: 'Скачать (PDF)',
                    downloadButtonGenerating: 'Генерация PDF...',
                    privacyTitle: 'Конфиденциальность',
                    privacyText: 'Мы не храним персональные данные постоянно. Введенный контент используется исключительно для немедленной обработки и автоматически удаляется после завершения сессии. Техническое обеспечение осуществляется через Railway, обработка определенного контента через OpenAI API – каждый в соответствии с требованиями GDPR.',
                    errorBiographyEmpty: 'Biography cannot be empty',
                    errorJobPostingEmpty: 'Job posting cannot be empty',
                    errorInvalidResponse: 'Invalid response from server',
                    errorApiError: 'Произошла ошибка',
                    errorPdfGeneration: 'Ошибка генерации PDF',
                    errorPdfError: 'Ошибка при генерации PDF: ',
                    alertFillLetter: 'Пожалуйста, сначала заполните письмо.'
                },
                en: {
                    appTitle: 'Bewerbunganschreiben AI',
                    themeToggle: 'Dark Mode',
                    themeToggleLight: 'Light Mode',
                    reviewPrompt: 'I would be grateful if you could leave a few lines with your impressions of this service',
                    submitReview: 'Submit Review',
                    biographyLabel: 'Biography - Write your resume in a free format: your skills, work experience, education:',
                    jobPostingLabel: 'Job Posting - simply copy the job posting text here.:',
                    wishesLabel: 'Wishes and Corrections - write your wishes or corrections if you are not satisfied with the result (optional):',
                    generateButton: 'Create Documents',
                    progressInitializing: 'Initializing...',
                    progressReadingBiography: 'Reading Biography',
                    progressAnalyzingBiography: 'Analyzing Biography',
                    progressReadingJobPosting: 'Reading Job Posting',
                    progressAnalyzingJobPosting: 'Analyzing Job Posting',
                    progressCreatingLetter: 'Creating Cover Letter',
                    progressGenerating: 'Generating Content...',
                    progressFinalizing: 'Finalizing Document',
                    progressComplete: 'Complete',
                    errorTitle: 'Error',
                    coverLetterTitle: 'Cover Letter (Anschreiben)',
                    downloadButton: 'Download (PDF)',
                    downloadButtonGenerating: 'Generating PDF...',
                    privacyTitle: 'Privacy',
                    privacyText: 'We do not store personal data permanently. Entered content is used exclusively for immediate processing and is automatically deleted after the session ends. Technical provision is done via Railway, processing of certain content via the OpenAI API – each in accordance with GDPR requirements.',
                    errorBiographyEmpty: 'Biography cannot be empty',
                    errorJobPostingEmpty: 'Job posting cannot be empty',
                    errorInvalidResponse: 'Invalid response from server',
                    errorApiError: 'An error occurred',
                    errorPdfGeneration: 'PDF generation failed',
                    errorPdfError: 'Error generating PDF: ',
                    alertFillLetter: 'Please fill in the cover letter first.'
                }
            };

            function safeGetStoredValue(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    return null;
                }
            }

            function safeStoreValue(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (error) {
                    // Storage can be blocked on some mobile browsers; ignore silently.
                }
            }

            function getCurrentLanguage() {
                const stored = safeGetStoredValue(LANGUAGE_STORAGE_KEY);
                return (stored && (stored === 'de' || stored === 'ru' || stored === 'en')) ? stored : 'de';
            }

            function translate(key, lang) {
                const langData = translations[lang] || translations.de;
                return langData[key] || key;
            }

            function applyTranslations(lang) {
                const elements = document.querySelectorAll('[data-i18n]');
                elements.forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const text = translate(key, lang);
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = text;
                    } else {
                        element.textContent = text;
                    }
                });

                // Update theme toggle text based on current theme
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    const isDark = document.documentElement.classList.contains('dark');
                    themeToggle.textContent = isDark 
                        ? translate('themeToggleLight', lang) 
                        : translate('themeToggle', lang);
                }
            }

            // Initialize language selector
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                const currentLang = getCurrentLanguage();
                languageSelector.value = currentLang;
                applyTranslations(currentLang);

                languageSelector.addEventListener('change', (e) => {
                    const newLang = e.target.value;
                    safeStoreValue(LANGUAGE_STORAGE_KEY, newLang);
                    applyTranslations(newLang);
                });
            }

            // Export translation function for use in other scripts
            window.i18n = {
                translate: (key) => translate(key, getCurrentLanguage()),
                getCurrentLanguage: getCurrentLanguage
            };
        })();

        // Progress Bar Management
        class ProgressBar {
            constructor() {
                this.segments = 24; // Number of segments in the ring
                this.currentProgress = 0;
                this.messages = [
                    { key: "progressReadingBiography", progress: 5 },
                    { key: "progressAnalyzingBiography", progress: 15 },
                    { key: "progressReadingJobPosting", progress: 25 },
                    { key: "progressAnalyzingJobPosting", progress: 40 },
                    { key: "progressCreatingLetter", progress: 50 },
                    { key: "progressGenerating", progress: 70 },
                    { key: "progressFinalizing", progress: 95 }
                ];
                this.currentMessageIndex = 0;
                this.init();
            }

            init() {
                const svg = document.querySelector('.progress-ring svg');
                const radius = 45;
                const circumference = 2 * Math.PI * radius;
                const segmentAngle = 360 / this.segments;
                const gapAngle = 2; // Gap between segments in degrees
                const arcAngle = segmentAngle - gapAngle;

                // Create segments as dashed arcs
                for (let i = 0; i < this.segments; i++) {
                    const startAngle = (i * segmentAngle - 90) * (Math.PI / 180);
                    const endAngle = (i * segmentAngle + arcAngle - 90) * (Math.PI / 180);
                    
                    // Calculate arc endpoints
                    const startX = 50 + radius * Math.cos(startAngle);
                    const startY = 50 + radius * Math.sin(startAngle);
                    const endX = 50 + radius * Math.cos(endAngle);
                    const endY = 50 + radius * Math.sin(endAngle);
                    
                    // Determine if arc is large (more than 180 degrees)
                    const largeArc = arcAngle > 180 ? 1 : 0;
                    
                    // Create path for arc segment
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}`);
                    path.setAttribute('class', 'progress-segment inactive');
                    path.setAttribute('data-index', i);
                    
                    // Make it dashed
                    const arcLength = (arcAngle / 360) * circumference;
                    const dashLength = arcLength * 0.6; // 60% dash
                    const dashGap = arcLength * 0.4; // 40% gap
                    path.setAttribute('stroke-dasharray', `${dashLength} ${dashGap}`);
                    
                    svg.appendChild(path);
                }
            }

            update(progress) {
                this.currentProgress = Math.min(100, Math.max(0, progress));
                const activeSegments = Math.floor((this.currentProgress / 100) * this.segments);
                const isComplete = this.currentProgress >= 100;
                
                // Update segments
                const segments = document.querySelectorAll('.progress-segment');
                segments.forEach((segment, index) => {
                    if (index < activeSegments) {
                        segment.classList.remove('inactive');
                        segment.classList.add('active');
                        // Add blinking animation if not complete
                        if (!isComplete) {
                            segment.classList.add('blinking');
                        } else {
                            segment.classList.remove('blinking');
                        }
                    } else {
                        segment.classList.remove('active');
                        segment.classList.remove('blinking');
                        segment.classList.add('inactive');
                    }
                });
                
                // Update percentage
                document.getElementById('progressPercent').textContent = Math.round(this.currentProgress) + '%';
                
                // Update message - find the last message where progress is >= current progress
                // Initialize with first message as fallback for progress < first threshold
                let message = this.messages[0];
                for (let i = this.messages.length - 1; i >= 0; i--) {
                    if (this.currentProgress >= this.messages[i].progress) {
                        message = this.messages[i];
                        break;
                    }
                }
                if (message) {
                    const label = document.getElementById('progressLabel');
                    label.textContent = window.i18n ? window.i18n.translate(message.key) : message.key;
                    label.classList.add('active');
                }
            }

            start() {
                this.currentProgress = 0;
                this.currentMessageIndex = 0;
                this.update(0);
            }

            complete() {
                this.update(100);
                // Remove blinking from all segments when complete
                const segments = document.querySelectorAll('.progress-segment');
                segments.forEach(segment => {
                    segment.classList.remove('blinking');
                });
                const label = document.getElementById('progressLabel');
                label.textContent = window.i18n ? window.i18n.translate('progressComplete') : 'Abgeschlossen';
                label.classList.add('active');
            }
        }

        // Initialize progress bar
        const progressBar = new ProgressBar();

        // Load sample data from separate files
        async function loadSampleData() {
            try {
                // Fetch sample biography
                const biographyResponse = await fetch('/sample_biography.txt');
                const sampleBiography = await biographyResponse.text();
                
                // Fetch sample job posting
                const jobPostingResponse = await fetch('/sample_job_posting.txt');
                const sampleJobPosting = await jobPostingResponse.text();
                
                // Initialize form with sample data
                document.getElementById('biographyTextarea').value = sampleBiography.trim();
                document.getElementById('jobPostingTextarea').value = sampleJobPosting.trim();
            } catch (error) {
                console.error('Error loading sample data:', error);
                // If files fail to load, leave textareas empty
            }
        }

        // Load sample data when page loads
        loadSampleData();

        // Form submission handler
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const biographyTextarea = document.getElementById('biographyTextarea');
            const jobPostingTextarea = document.getElementById('jobPostingTextarea');
            const wishesTextarea = document.getElementById('wishesTextarea');
            const generateButton = document.getElementById('generateButton');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const errorSection = document.getElementById('errorSection');
            const errorContent = document.getElementById('errorContent');
            
            // Hide previous results
            results.classList.add('hidden');
            errorSection.classList.add('hidden');
            
            // Show loading state
            loading.classList.remove('hidden');
            generateButton.disabled = true;
            
            // Start progress bar
            progressBar.start();
            
            let progressInterval = null;
            let generationProgressInterval = null;
            
            try {
                // Validate biography text
                const biographyText = biographyTextarea.value.trim();
                if (!biographyText || biographyText.length === 0) {
                    throw new Error(window.i18n ? window.i18n.translate('errorBiographyEmpty') : 'Biography cannot be empty');
                }
                
                // Validate job posting
                const jobPostingText = jobPostingTextarea.value.trim();
                if (!jobPostingText || jobPostingText.length === 0) {
                    throw new Error(window.i18n ? window.i18n.translate('errorJobPostingEmpty') : 'Job posting cannot be empty');
                }
                
                // Update progress: Reading biography
                progressBar.update(5);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update progress: Analyzing biography
                progressBar.update(15);
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // Create a Blob from the biography text and convert it to a File
                const biographyBlob = new Blob([biographyText], { type: 'text/plain' });
                const biographyFile = new File([biographyBlob], 'biography.txt', { type: 'text/plain' });
                
                // Update progress: Reading job posting
                progressBar.update(25);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update progress: Analyzing job posting
                progressBar.update(40);
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // Prepare form data
                const formData = new FormData();
                formData.append('biographyFile', biographyFile);
                formData.append('jobPosting', jobPostingText);
                const wishesText = wishesTextarea.value.trim();
                if (wishesText) {
                    formData.append('wishes', wishesText);
                }
                
                // Update progress: Starting generation
                progressBar.update(50);
                
                // Start simulating progress during generation (50% to 95%)
                let generationProgress = 50;
                generationProgressInterval = setInterval(() => {
                    if (generationProgress < 95) {
                        // Slow down as we approach 95%
                        const remaining = 95 - generationProgress;
                        const increment = remaining > 10 ? 0.8 : (remaining > 5 ? 0.4 : 0.2);
                        generationProgress = Math.min(95, generationProgress + increment);
                        progressBar.update(generationProgress);
                    }
                }, 400); // Update every 400ms
                
                // Send POST request
                const response = await fetch('/api/generate/from-file', {
                    method: 'POST',
                    body: formData
                });
                
                // Stop generation progress simulation
                if (generationProgressInterval) {
                    clearInterval(generationProgressInterval);
                    generationProgressInterval = null;
                }
                
                // Update progress: Finalizing
                progressBar.update(95);
                
                // Parse response
                let responseData;
                try {
                    responseData = await response.json();
                } catch (jsonError) {
                    throw new Error(window.i18n ? window.i18n.translate('errorInvalidResponse') : 'Invalid response from server');
                }
                
                if (!response.ok) {
                    // Handle API error response
                    const errorMessage = responseData.message || responseData.error || (window.i18n ? window.i18n.translate('errorApiError') : 'An error occurred');
                    throw new Error(`API Error (${response.status}): ${errorMessage}`);
                }
                
                // Complete progress
                if (generationProgressInterval) {
                    clearInterval(generationProgressInterval);
                }
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                progressBar.complete();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Display results
                document.getElementById('coverLetterTextarea').value = responseData.coverLetter || 'No cover letter generated';
                results.classList.remove('hidden');
                
            } catch (error) {
                // Stop progress simulation on error
                if (generationProgressInterval) {
                    clearInterval(generationProgressInterval);
                }
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                // Display error
                errorContent.textContent = error.message || 'An unexpected error occurred';
                errorSection.classList.remove('hidden');
                console.error('Error:', error);
            } finally {
                // Hide loading state
                loading.classList.add('hidden');
                generateButton.disabled = false;
            }
        });

        // Download PDF button handler
        document.getElementById('downloadButton').addEventListener('click', async function() {
            const coverLetterText = document.getElementById('coverLetterTextarea').value;
            const downloadButton = document.getElementById('downloadButton');
            
            if (!coverLetterText || coverLetterText.trim().length === 0) {
                alert(window.i18n ? window.i18n.translate('alertFillLetter') : 'Bitte füllen Sie zuerst das Anschreiben aus.');
                return;
            }
            
            downloadButton.disabled = true;
            downloadButton.textContent = window.i18n ? window.i18n.translate('downloadButtonGenerating') : 'PDF wird generiert...';
            
            try {
                const response = await fetch('/api/generate/pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coverLetter: coverLetterText })
                });
                
                if (!response.ok) {
                    throw new Error(window.i18n ? window.i18n.translate('errorPdfGeneration') : 'PDF-Generierung fehlgeschlagen');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Anschreiben.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                const errorMsg = window.i18n ? window.i18n.translate('errorPdfError') : 'Fehler beim Generieren des PDFs: ';
                alert(errorMsg + error.message);
            } finally {
                downloadButton.disabled = false;
                downloadButton.textContent = window.i18n ? window.i18n.translate('downloadButton') : 'Herunterladen (PDF)';
            }
        });
    </script>
</body>
</html>

