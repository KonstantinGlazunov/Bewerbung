<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bewerbung AI - Document Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            min-height: 150px;
        }

        #biographyTextarea {
            min-height: 300px;
        }

        #jobPostingTextarea {
            min-height: 200px;
        }

        #wishesTextarea {
            min-height: 150px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
        }

        .result-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .result-section h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .result-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .result-content.editable {
            padding: 0;
            border: none;
            background: transparent;
        }

        #coverLetterTextarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            background: white;
        }

        #coverLetterTextarea:focus {
            outline: 2px solid #007bff;
            outline-offset: -2px;
        }

        .error {
            background-color: #fff5f5;
            border-left-color: #dc3545;
            color: #dc3545;
        }

        .error .result-content {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        /* Progress Bar Styles */
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: white;
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-segment {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke 0.4s ease;
        }

        .progress-segment.active {
            stroke: url(#gradient);
        }

        .progress-segment.active.blinking {
            animation: blink-segment 1.2s ease-in-out infinite;
        }

        @keyframes blink-segment {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.4;
            }
        }

        .progress-segment.inactive {
            stroke: #f5f5f5;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        .progress-label {
            margin-top: 30px;
            font-size: 16px;
            color: #666;
            text-align: center;
            min-height: 24px;
            font-weight: 500;
        }

        .progress-label.active {
            color: #007bff;
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 12px;
            line-height: 1.6;
        }

        footer h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        footer p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bewerbunganschreiben AI</h1>
        
        <form id="generateForm">
            <div class="form-group">
                <label for="biographyTextarea">Biography - Verfassen Sie Ihren Lebenslauf in einem freien Format: Persönliches
                    Daten, Ihre Fähigkeiten, Berufserfahrung, Ausbildung:</label>
                <textarea id="biographyTextarea" name="biography" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="jobPostingTextarea">Job Posting - kopieren Sie einfach den Text der Stellenanzeige hierher.:</label>
                <textarea id="jobPostingTextarea" name="jobPosting" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="wishesTextarea">Wünsche und Korrekturen - schreiben Sie Ihre Wünsche oder Korrekturen, wenn Sie mit dem Ergebnis nicht einverstanden sind (optional):</label>
                <textarea id="wishesTextarea" name="wishes"></textarea>
            </div>
            
            <button type="submit" id="generateButton">Generate Documents</button>
        </form>

        <div id="loading" class="loading hidden">
            <div class="progress-container">
                <div class="progress-ring">
                    <svg viewBox="0 0 100 100">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#5dade2;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#007bff;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- Segments will be generated by JavaScript -->
                    </svg>
                    <div class="progress-text" id="progressPercent">0%</div>
                </div>
                <div class="progress-label" id="progressLabel">Initialisiere...</div>
            </div>
        </div>

        <div id="errorSection" class="results hidden">
            <div class="result-section error">
                <h2>Error</h2>
                <div class="result-content" id="errorContent"></div>
            </div>
        </div>

        <div id="results" class="results hidden">
            <div class="result-section">
                <h2>Cover Letter (Anschreiben)</h2>
                <textarea id="coverLetterTextarea" class="result-content editable"></textarea>
                <button type="button" id="downloadButton" style="margin-top: 15px;">Herunterladen (PDF)</button>
            </div>
        </div>

        <footer>
            <h3>Datenschutz</h3>
            <p>Wir speichern keine personenbezogenen Daten dauerhaft. Eingegebene Inhalte werden ausschließlich zur unmittelbaren Verarbeitung verwendet und nach Beendigung der Sitzung automatisch gelöscht. Die technische Bereitstellung erfolgt über Railway, die Verarbeitung bestimmter Inhalte über die OpenAI-API – jeweils gemäß den Anforderungen der DSGVO.</p>
        </footer>
    </div>

    <script>
        // Progress Bar Management
        class ProgressBar {
            constructor() {
                this.segments = 24; // Number of segments in the ring
                this.currentProgress = 0;
                this.messages = [
                    { text: "Lese Lebenslauf", progress: 5 },
                    { text: "Analysiere Lebenslauf", progress: 15 },
                    { text: "Lese Stellenausschreibung", progress: 25 },
                    { text: "Analysiere Stellenausschreibung", progress: 40 },
                    { text: "Erstelle Anschreiben", progress: 50 },
                    { text: "Generiere Inhalt...", progress: 70 },
                    { text: "Finalisiere Dokument", progress: 95 }
                ];
                this.currentMessageIndex = 0;
                this.init();
            }

            init() {
                const svg = document.querySelector('.progress-ring svg');
                const radius = 45;
                const circumference = 2 * Math.PI * radius;
                const segmentAngle = 360 / this.segments;
                const gapAngle = 2; // Gap between segments in degrees
                const arcAngle = segmentAngle - gapAngle;

                // Create segments as dashed arcs
                for (let i = 0; i < this.segments; i++) {
                    const startAngle = (i * segmentAngle - 90) * (Math.PI / 180);
                    const endAngle = (i * segmentAngle + arcAngle - 90) * (Math.PI / 180);
                    
                    // Calculate arc endpoints
                    const startX = 50 + radius * Math.cos(startAngle);
                    const startY = 50 + radius * Math.sin(startAngle);
                    const endX = 50 + radius * Math.cos(endAngle);
                    const endY = 50 + radius * Math.sin(endAngle);
                    
                    // Determine if arc is large (more than 180 degrees)
                    const largeArc = arcAngle > 180 ? 1 : 0;
                    
                    // Create path for arc segment
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}`);
                    path.setAttribute('class', 'progress-segment inactive');
                    path.setAttribute('data-index', i);
                    
                    // Make it dashed
                    const arcLength = (arcAngle / 360) * circumference;
                    const dashLength = arcLength * 0.6; // 60% dash
                    const dashGap = arcLength * 0.4; // 40% gap
                    path.setAttribute('stroke-dasharray', `${dashLength} ${dashGap}`);
                    
                    svg.appendChild(path);
                }
            }

            update(progress) {
                this.currentProgress = Math.min(100, Math.max(0, progress));
                const activeSegments = Math.floor((this.currentProgress / 100) * this.segments);
                const isComplete = this.currentProgress >= 100;
                
                // Update segments
                const segments = document.querySelectorAll('.progress-segment');
                segments.forEach((segment, index) => {
                    if (index < activeSegments) {
                        segment.classList.remove('inactive');
                        segment.classList.add('active');
                        // Add blinking animation if not complete
                        if (!isComplete) {
                            segment.classList.add('blinking');
                        } else {
                            segment.classList.remove('blinking');
                        }
                    } else {
                        segment.classList.remove('active');
                        segment.classList.remove('blinking');
                        segment.classList.add('inactive');
                    }
                });
                
                // Update percentage
                document.getElementById('progressPercent').textContent = Math.round(this.currentProgress) + '%';
                
                // Update message - find the last message where progress is >= current progress
                // Initialize with first message as fallback for progress < first threshold
                let message = this.messages[0];
                for (let i = this.messages.length - 1; i >= 0; i--) {
                    if (this.currentProgress >= this.messages[i].progress) {
                        message = this.messages[i];
                        break;
                    }
                }
                if (message) {
                    const label = document.getElementById('progressLabel');
                    label.textContent = message.text;
                    label.classList.add('active');
                }
            }

            start() {
                this.currentProgress = 0;
                this.currentMessageIndex = 0;
                this.update(0);
            }

            complete() {
                this.update(100);
                // Remove blinking from all segments when complete
                const segments = document.querySelectorAll('.progress-segment');
                segments.forEach(segment => {
                    segment.classList.remove('blinking');
                });
                const label = document.getElementById('progressLabel');
                label.textContent = "Abgeschlossen";
                label.classList.add('active');
            }
        }

        // Initialize progress bar
        const progressBar = new ProgressBar();

        // Load sample data from separate files
        async function loadSampleData() {
            try {
                // Fetch sample biography
                const biographyResponse = await fetch('/sample_biography.txt');
                const sampleBiography = await biographyResponse.text();
                
                // Fetch sample job posting
                const jobPostingResponse = await fetch('/sample_job_posting.txt');
                const sampleJobPosting = await jobPostingResponse.text();
                
                // Initialize form with sample data
                document.getElementById('biographyTextarea').value = sampleBiography.trim();
                document.getElementById('jobPostingTextarea').value = sampleJobPosting.trim();
            } catch (error) {
                console.error('Error loading sample data:', error);
                // If files fail to load, leave textareas empty
            }
        }

        // Load sample data when page loads
        loadSampleData();

        // Form submission handler
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const biographyTextarea = document.getElementById('biographyTextarea');
            const jobPostingTextarea = document.getElementById('jobPostingTextarea');
            const wishesTextarea = document.getElementById('wishesTextarea');
            const generateButton = document.getElementById('generateButton');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const errorSection = document.getElementById('errorSection');
            const errorContent = document.getElementById('errorContent');
            
            // Hide previous results
            results.classList.add('hidden');
            errorSection.classList.add('hidden');
            
            // Show loading state
            loading.classList.remove('hidden');
            generateButton.disabled = true;
            
            // Start progress bar
            progressBar.start();
            
            let progressInterval = null;
            let generationProgressInterval = null;
            
            try {
                // Validate biography text
                const biographyText = biographyTextarea.value.trim();
                if (!biographyText || biographyText.length === 0) {
                    throw new Error('Biography cannot be empty');
                }
                
                // Validate job posting
                const jobPostingText = jobPostingTextarea.value.trim();
                if (!jobPostingText || jobPostingText.length === 0) {
                    throw new Error('Job posting cannot be empty');
                }
                
                // Update progress: Reading biography
                progressBar.update(5);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update progress: Analyzing biography
                progressBar.update(15);
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // Create a Blob from the biography text and convert it to a File
                const biographyBlob = new Blob([biographyText], { type: 'text/plain' });
                const biographyFile = new File([biographyBlob], 'biography.txt', { type: 'text/plain' });
                
                // Update progress: Reading job posting
                progressBar.update(25);
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update progress: Analyzing job posting
                progressBar.update(40);
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // Prepare form data
                const formData = new FormData();
                formData.append('biographyFile', biographyFile);
                formData.append('jobPosting', jobPostingText);
                const wishesText = wishesTextarea.value.trim();
                if (wishesText) {
                    formData.append('wishes', wishesText);
                }
                
                // Update progress: Starting generation
                progressBar.update(50);
                
                // Start simulating progress during generation (50% to 95%)
                let generationProgress = 50;
                generationProgressInterval = setInterval(() => {
                    if (generationProgress < 95) {
                        // Slow down as we approach 95%
                        const remaining = 95 - generationProgress;
                        const increment = remaining > 10 ? 0.8 : (remaining > 5 ? 0.4 : 0.2);
                        generationProgress = Math.min(95, generationProgress + increment);
                        progressBar.update(generationProgress);
                    }
                }, 400); // Update every 400ms
                
                // Send POST request
                const response = await fetch('/api/generate/from-file', {
                    method: 'POST',
                    body: formData
                });
                
                // Stop generation progress simulation
                if (generationProgressInterval) {
                    clearInterval(generationProgressInterval);
                    generationProgressInterval = null;
                }
                
                // Update progress: Finalizing
                progressBar.update(95);
                
                // Parse response
                let responseData;
                try {
                    responseData = await response.json();
                } catch (jsonError) {
                    throw new Error('Invalid response from server');
                }
                
                if (!response.ok) {
                    // Handle API error response
                    const errorMessage = responseData.message || responseData.error || 'An error occurred';
                    throw new Error(`API Error (${response.status}): ${errorMessage}`);
                }
                
                // Complete progress
                if (generationProgressInterval) {
                    clearInterval(generationProgressInterval);
                }
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                progressBar.complete();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Display results
                document.getElementById('coverLetterTextarea').value = responseData.coverLetter || 'No cover letter generated';
                results.classList.remove('hidden');
                
            } catch (error) {
                // Stop progress simulation on error
                if (generationProgressInterval) {
                    clearInterval(generationProgressInterval);
                }
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                // Display error
                errorContent.textContent = error.message || 'An unexpected error occurred';
                errorSection.classList.remove('hidden');
                console.error('Error:', error);
            } finally {
                // Hide loading state
                loading.classList.add('hidden');
                generateButton.disabled = false;
            }
        });

        // Download PDF button handler
        document.getElementById('downloadButton').addEventListener('click', async function() {
            const coverLetterText = document.getElementById('coverLetterTextarea').value;
            const downloadButton = document.getElementById('downloadButton');
            
            if (!coverLetterText || coverLetterText.trim().length === 0) {
                alert('Bitte füllen Sie zuerst das Anschreiben aus.');
                return;
            }
            
            downloadButton.disabled = true;
            downloadButton.textContent = 'PDF wird generiert...';
            
            try {
                const response = await fetch('/api/generate/pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coverLetter: coverLetterText })
                });
                
                if (!response.ok) {
                    throw new Error('PDF-Generierung fehlgeschlagen');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Anschreiben.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Fehler beim Generieren des PDFs: ' + error.message);
            } finally {
                downloadButton.disabled = false;
                downloadButton.textContent = 'Herunterladen (PDF)';
            }
        });
    </script>
</body>
</html>

