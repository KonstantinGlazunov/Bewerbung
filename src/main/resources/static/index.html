<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bewerbung AI - Document Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            min-height: 150px;
        }

        #biographyTextarea {
            min-height: 300px;
        }

        #jobPostingTextarea {
            min-height: 200px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
        }

        .result-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .result-section h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .result-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .result-content.editable {
            padding: 0;
            border: none;
            background: transparent;
        }

        #coverLetterTextarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            background: white;
        }

        #coverLetterTextarea:focus {
            outline: 2px solid #007bff;
            outline-offset: -2px;
        }

        .error {
            background-color: #fff5f5;
            border-left-color: #dc3545;
            color: #dc3545;
        }

        .error .result-content {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 12px;
            line-height: 1.6;
        }

        footer h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        footer p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bewerbunganschreiben AI Generator</h1>
        
        <form id="generateForm">
            <div class="form-group">
                <label for="biographyTextarea">Biography - Verfassen Sie Ihren Lebenslauf in einem freien Format: Persönliches
                    Daten, Ihre Fähigkeiten, Berufserfahrung, Ausbildung:</label>
                <textarea id="biographyTextarea" name="biography" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="jobPostingTextarea">Job Posting - kopieren Sie einfach den Text der Stellenanzeige hierher.:</label>
                <textarea id="jobPostingTextarea" name="jobPosting" required></textarea>
            </div>
            
            <button type="submit" id="generateButton">Generate Documents</button>
        </form>

        <div id="loading" class="loading hidden">Generating documents...</div>

        <div id="errorSection" class="results hidden">
            <div class="result-section error">
                <h2>Error</h2>
                <div class="result-content" id="errorContent"></div>
            </div>
        </div>

        <div id="results" class="results hidden">
            <div class="result-section">
                <h2>Cover Letter (Anschreiben)</h2>
                <textarea id="coverLetterTextarea" class="result-content editable"></textarea>
                <button type="button" id="downloadButton" style="margin-top: 15px;">Herunterladen (PDF)</button>
            </div>
        </div>

        <footer>
            <h3>Datenschutz</h3>
            <p>Wir speichern keine personenbezogenen Daten dauerhaft. Eingegebene Inhalte werden ausschließlich zur unmittelbaren Verarbeitung verwendet und nach Beendigung der Sitzung automatisch gelöscht. Die technische Bereitstellung erfolgt über Railway, die Verarbeitung bestimmter Inhalte über die OpenAI-API – jeweils gemäß den Anforderungen der DSGVO.</p>
        </footer>
    </div>

    <script>
        // Load sample data from separate files
        async function loadSampleData() {
            try {
                // Fetch sample biography
                const biographyResponse = await fetch('/sample_biography.txt');
                const sampleBiography = await biographyResponse.text();
                
                // Fetch sample job posting
                const jobPostingResponse = await fetch('/sample_job_posting.txt');
                const sampleJobPosting = await jobPostingResponse.text();
                
                // Initialize form with sample data
                document.getElementById('biographyTextarea').value = sampleBiography.trim();
                document.getElementById('jobPostingTextarea').value = sampleJobPosting.trim();
            } catch (error) {
                console.error('Error loading sample data:', error);
                // If files fail to load, leave textareas empty
            }
        }

        // Load sample data when page loads
        loadSampleData();

        // Form submission handler
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const biographyTextarea = document.getElementById('biographyTextarea');
            const jobPostingTextarea = document.getElementById('jobPostingTextarea');
            const generateButton = document.getElementById('generateButton');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const errorSection = document.getElementById('errorSection');
            const errorContent = document.getElementById('errorContent');
            
            // Hide previous results
            results.classList.add('hidden');
            errorSection.classList.add('hidden');
            
            // Show loading state
            loading.classList.remove('hidden');
            generateButton.disabled = true;
            
            try {
                // Validate biography text
                const biographyText = biographyTextarea.value.trim();
                if (!biographyText || biographyText.length === 0) {
                    throw new Error('Biography cannot be empty');
                }
                
                // Validate job posting
                const jobPostingText = jobPostingTextarea.value.trim();
                if (!jobPostingText || jobPostingText.length === 0) {
                    throw new Error('Job posting cannot be empty');
                }
                
                // Create a Blob from the biography text and convert it to a File
                const biographyBlob = new Blob([biographyText], { type: 'text/plain' });
                const biographyFile = new File([biographyBlob], 'biography.txt', { type: 'text/plain' });
                
                // Prepare form data
                const formData = new FormData();
                formData.append('biographyFile', biographyFile);
                formData.append('jobPosting', jobPostingText);
                
                // Send POST request
                const response = await fetch('/api/generate/from-file', {
                    method: 'POST',
                    body: formData
                });
                
                // Parse response
                let responseData;
                try {
                    responseData = await response.json();
                } catch (jsonError) {
                    throw new Error('Invalid response from server');
                }
                
                if (!response.ok) {
                    // Handle API error response
                    const errorMessage = responseData.message || responseData.error || 'An error occurred';
                    throw new Error(`API Error (${response.status}): ${errorMessage}`);
                }
                
                // Display results
                document.getElementById('coverLetterTextarea').value = responseData.coverLetter || 'No cover letter generated';
                results.classList.remove('hidden');
                
            } catch (error) {
                // Display error
                errorContent.textContent = error.message || 'An unexpected error occurred';
                errorSection.classList.remove('hidden');
                console.error('Error:', error);
            } finally {
                // Hide loading state
                loading.classList.add('hidden');
                generateButton.disabled = false;
            }
        });

        // Download PDF button handler
        document.getElementById('downloadButton').addEventListener('click', async function() {
            const coverLetterText = document.getElementById('coverLetterTextarea').value;
            const downloadButton = document.getElementById('downloadButton');
            
            if (!coverLetterText || coverLetterText.trim().length === 0) {
                alert('Bitte füllen Sie zuerst das Anschreiben aus.');
                return;
            }
            
            downloadButton.disabled = true;
            downloadButton.textContent = 'PDF wird generiert...';
            
            try {
                const response = await fetch('/api/generate/pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coverLetter: coverLetterText })
                });
                
                if (!response.ok) {
                    throw new Error('PDF-Generierung fehlgeschlagen');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Anschreiben.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Fehler beim Generieren des PDFs: ' + error.message);
            } finally {
                downloadButton.disabled = false;
                downloadButton.textContent = 'Herunterladen (PDF)';
            }
        });
    </script>
</body>
</html>

